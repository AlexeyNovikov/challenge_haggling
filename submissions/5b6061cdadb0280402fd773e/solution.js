'use strict';const greedyness=100500,to_str=(a)=>a.map((a)=>a.toString(16)).join(""),to_arr=(a)=>a.split("").map((a)=>parseInt(a,16)),sum=(a)=>a.reduce((a,d)=>a+d,0),strict_subset=(a,c)=>{a=a.split("");c=c.split("");let d=!1;for(let b=0;3>b;b++){if(a[b]>c[b])return!1;a[b]<c[b]&&(d=!0)}return d},things=(a)=>sum(to_arr(a)),avail_offers={111:"001 010 011 100 101 110".split(" "),112:"001 002 010 011 012 100 101 102 110 111".split(" "),113:"001 002 003 010 011 012 013 100 101 102 103 110 111 112".split(" "),
114:"001 002 003 004 010 011 012 013 014 100 101 102 103 104 110 111 112 113".split(" "),121:"001 010 011 020 021 100 101 110 111 120".split(" "),122:"001 002 010 011 012 020 021 022 100 101 102 110 111 112 120 121".split(" "),123:"001 002 003 010 011 012 013 020 021 022 023 100 101 102 103 110 111 112 113 120 121 122".split(" "),131:"001 010 011 020 021 030 031 100 101 110 111 120 121 130".split(" "),132:"001 002 010 011 012 020 021 022 030 031 032 100 101 102 110 111 112 120 121 122 130 131".split(" "),
141:"001 010 011 020 021 030 031 040 041 100 101 110 111 120 121 130 131 140".split(" "),211:"001 010 011 100 101 110 111 200 201 210".split(" "),212:"001 002 010 011 012 100 101 102 110 111 112 200 201 202 210 211".split(" "),213:"001 002 003 010 011 012 013 100 101 102 103 110 111 112 113 200 201 202 203 210 211 212".split(" "),221:"001 010 011 020 021 100 101 110 111 120 121 200 201 210 211 220".split(" "),222:"001 002 010 011 012 020 021 022 100 101 102 110 111 112 120 121 122 200 201 202 210 211 212 220 221".split(" "),
231:"001 010 011 020 021 030 031 100 101 110 111 120 121 130 131 200 201 210 211 220 221 230".split(" "),311:"001 010 011 100 101 110 111 200 201 210 211 300 301 310".split(" "),312:"001 002 010 011 012 100 101 102 110 111 112 200 201 202 210 211 212 300 301 302 310 311".split(" "),321:"001 010 011 020 021 100 101 110 111 120 121 200 201 210 211 220 221 300 301 310 311 320".split(" "),411:"001 010 011 100 101 110 111 200 201 210 211 300 301 310 311 400 401 410".split(" ")},avail_valuations={111:"00a 019 028 037 046 055 064 073 082 091 0a0 109 118 127 136 145 154 163 172 181 190 208 217 226 235 244 253 262 271 280 307 316 325 334 343 352 361 370 406 415 424 433 442 451 460 505 514 523 532 541 550 604 613 622 631 640 703 712 721 730 802 811 820 901 910 a00".split(" "),
112:"005 024 043 062 081 0a0 114 133 152 171 190 204 223 242 261 280 313 332 351 370 403 422 441 460 512 531 550 602 621 640 711 730 801 820 910 a00".split(" "),113:"013 042 071 0a0 103 132 161 190 222 251 280 312 341 370 402 431 460 521 550 611 640 701 730 820 910 a00".split(" "),114:"022 061 0a0 112 151 190 202 241 280 331 370 421 460 511 550 601 640 730 820 910 a00".split(" "),121:"00a 018 026 034 042 050 109 117 125 133 141 208 216 224 232 240 307 315 323 331 406 414 422 430 505 513 521 604 612 620 703 711 802 810 901 a00".split(" "),
122:"005 014 023 032 041 050 204 213 222 231 240 403 412 421 430 602 611 620 801 810 a00".split(" "),123:"022 050 103 131 212 240 321 402 430 511 620 701 810 a00".split(" "),131:"00a 017 024 031 109 116 123 130 208 215 222 307 314 321 406 413 420 505 512 604 611 703 710 802 901 a00".split(" "),132:"005 022 113 130 204 221 312 403 420 511 602 710 801 a00".split(" "),141:"00a 016 022 109 115 121 208 214 220 307 313 406 412 505 511 604 610 703 802 901 a00".split(" "),211:"00a 019 028 037 046 055 064 073 082 091 0a0 108 117 126 135 144 153 162 171 180 206 215 224 233 242 251 260 304 313 322 331 340 402 411 420 500".split(" "),
212:"005 024 043 062 081 0a0 104 123 142 161 180 203 222 241 260 302 321 340 401 420 500".split(" "),213:"013 042 071 0a0 122 151 180 202 231 260 311 340 420 500".split(" "),221:"00a 018 026 034 042 050 108 116 124 132 140 206 214 222 230 304 312 320 402 410 500".split(" "),222:"005 014 023 032 041 050 104 113 122 131 140 203 212 221 230 302 311 320 401 410 500".split(" "),231:"00a 017 024 031 108 115 122 206 213 220 304 311 402 500".split(" "),311:"00a 019 028 037 046 055 064 073 082 091 0a0 107 116 125 134 143 152 161 170 204 213 222 231 240 301 310".split(" "),
312:"005 024 043 062 081 0a0 113 132 151 170 202 221 240 310".split(" "),321:"00a 018 026 034 042 050 107 115 123 131 204 212 220 301".split(" "),411:"00a 019 028 037 046 055 064 073 082 091 0a0 106 115 124 133 142 151 160 202 211 220".split(" ")};
module.exports=class{constructor(a,c,d,b,h){this.me=a;this.counts=c;this.values=d;this.rounds=b;this.log=h;this.total=0;this.value=(a)=>sum(to_arr(a).map((a,b)=>a*d[b]));this.value2=(a,b)=>sum(to_arr(a).map((a,g)=>parseInt(b.slice(g,g+1),16)*(c[g]-a)));const e=to_str(d);b=to_str(c);this.vals=avail_valuations[b].filter((a)=>a!=e);this.vals_copy=this.vals.slice();this.offers=avail_offers[b].filter(this.value);this.sort_offers=(a,b)=>this.value(b)-this.value(a)||sum((this.vals.length&&this.vals||this.vals_copy).map((b)=>
this.value2(a,b)))-sum((this.vals.length&&this.vals||this.vals_copy).map((a)=>this.value2(b,a)))||things(b)-things(a)||a-b;this.offers.sort(this.sort_offers);this.best_we_can_hope_for=this.value(this.offers[0]);if(a){/0../.test(e)?/00./.test(e)?this.offers=this.offers.filter((a)=>/00./.test(a)):/0.0/.test(e)?this.offers=this.offers.filter((a)=>/0.0/.test(a)):this.offers=this.offers.filter((a)=>/0../.test(a)):/.0./.test(e)?/.00/.test(e)?this.offers=this.offers.filter((a)=>/.00/.test(a)):this.offers=
this.offers.filter((a)=>/.0./.test(a)):/..0/.test(e)&&(this.offers=this.offers.filter((a)=>/..0/.test(a)));let a=3;if("111"==b)a=1;else if("114"==b||"122"==b)a=5;else if("212"==b||"221"==b)a=2;this.offers=this.offers.filter((b)=>this.value(b)>this.best_we_can_hope_for-a)}else this.offers="111"==b?this.offers.filter((a)=>this.value(a)>this.best_we_can_hope_for-2):this.offers.filter((a)=>this.value(a)>this.best_we_can_hope_for-1);this.offers_sent=[];this.offers_received=[];this.greedyness=0}offer(a){this.log(`${this.rounds} rounds left`);
this.rounds--;if(!a){var c=this.offers.shift();this.offers_sent.push(c);return to_arr(c)}const d=to_str(a);if(this.me&&!this.rounds)return this.value(d)?void 0:this.counts.slice();if(!(this.value(d)>=this.best_we_can_hope_for||this.offers_sent.includes(d))){if(this.me&&1==this.rounds){var b=this.best_we_can_hope_for-4,h=to_str(this.counts);if("111"==h)b=7;else if("112"==h||"121"==h||"211"==h)b=6;else if("114"==h||"141"==h)b=5;h=[d,...this.offers_received];var e;for(var k of h)this.value(k)<b||e&&
!(this.value(k)>this.value(e))||(e=k);if(e)return e==d?void 0:to_arr(e)}if(this.offers_sent.length){const a=this.offers_sent[this.offers_sent.length-1];this.vals=this.vals.filter((b)=>10!=this.value2(a,b))}this.offers_received.length&&this.vals.length&&!this.offers_received.includes(d)&&!this.offers_received.some((a)=>strict_subset(d,a))&&(this.vals=this.vals.filter((a)=>{const b=this.value2(d,a);return b&&!this.offers_received.some((m)=>this.value2(m,a)<b)}));this.offers_received.length||(b=a.filter((a)=>
0!=a).length,2==b?/0../.test(d)?a[1]==this.counts[1]&&a[2]==this.counts[2]&&(this.vals=this.vals.filter((a)=>/.00/.test(a))):/.0./.test(d)?a[0]==this.counts[0]&&a[2]==this.counts[2]&&(this.vals=this.vals.filter((a)=>/0.0/.test(a))):/..0/.test(d)&&a[0]==this.counts[0]&&a[1]==this.counts[1]&&(this.vals=this.vals.filter((a)=>/00./.test(a))):1==b&&(a[0]?(this.vals=this.vals.filter((a)=>{a=to_arr(a);return a[0]<=a[1]&&a[0]<=a[2]}),a[0]==this.counts[0]&&1<this.counts[0]&&(this.vals=this.vals.filter((a)=>
/0../.test(a)))):a[1]?(this.vals=this.vals.filter((a)=>{a=to_arr(a);return a[1]<=a[0]&&a[1]<=a[2]}),a[1]==this.counts[1]&&1<this.counts[1]&&(this.vals=this.vals.filter((a)=>/.0./.test(a)))):a[2]&&(this.vals=this.vals.filter((a)=>{a=to_arr(a);return a[2]<=a[0]&&a[2]<=a[1]}),a[2]==this.counts[2]&&1<this.counts[2]&&(this.vals=this.vals.filter((a)=>/..0/.test(a))))));this.value(d)>this.greedyness&&(this.greedyness=this.value(d));this.offers_received.push(d);this.offers=this.offers.filter((a)=>a!=d&&this.value(a)>=
this.greedyness&&this.vals.some((b)=>this.value2(a,b))&&!strict_subset(a,d));this.offers.sort(this.sort_offers);if(!this.rounds){b=this.offers_received.slice();a=b.sort(this.sort_offers).shift();for(var g of b){b=this.value(g);if(b==this.value(a)&&g==d){a=g;break}if(b<this.value(a))break}b=0;e=this.vals.length&&this.vals||this.vals_copy;g=Array(e.length);for(k=0;k<g.length;k++){h=0;for(var l of this.offers_received)h+=this.value2(l,e[k]);b+=h;g[k]=[e[k],h]}g.sort((a,b)=>b[1]-a[1]||a[0]-b[0]);for(l=
0;l<g.length;l++)g[l][1]/=b;l=this.value(a);e="000";b=avail_offers[to_str(this.counts)].filter((a)=>!this.offers_received.includes(a));k=0;for(c of b)if(this.value(c)){b=0;for(var f of g)b=this.value2(c,f[0])?b+(this.value(c)-l)*f[1]:b-l*f[1];if(b>k||b==k&&this.value(c)>this.value(e))[k,e]=[b,c]}return this.value(a)&&this.value(a)>=this.value(e)?a==d?void 0:to_arr(a):this.value(e)?to_arr(e):to_arr(this.offers_sent[0])}if(this.offers.length)c=this.offers.shift();else if(this.offers_sent.length)c=this.offers_sent[0];
else{c=this.counts.slice();for(f=0;f<c.length;f++)c[f]=this.values[f]?c[f]:0;if(c[0]&&c[1]&&c[2]){f=10;l=0;for(a=0;a<this.values.length;a++)this.values[a]<f&&(f=this.values[a],l=a);c[l]--}c=to_str(c);f=this.offers_received.slice();f.sort(this.sort_offers);f.length&&this.value(f[0])>=this.value(c)&&(c=f[0])}this.offers_sent.push(c);return c==d?void 0:to_arr(c)}}};
